const o=globalThis.chrome;let n=null;function w(i){try{let t=new URL(i).hostname;t.startsWith("www.")&&(t=t.substring(4));const a=t.split("."),r=a.length;if(r<=2)return t;const c=["uk","au","jp","br","cn","in","ca","de","fr","es","it","nl","ru","us"],l=["com","co","net","org","gov","edu","ac"],s=a[r-1],d=a[r-2];return c.includes(s)&&l.includes(d)?`${a[r-3]}.${d}.${s}`:`${d}.${s}`}catch(e){return console.error("Invalid URL for domain extraction:",i,e),i}}async function m(i,e){if(!i||e<=0)return;const t=w(i),r=(await o.storage.local.get(["websites"])).websites||[],c=r.findIndex(s=>w(s.url)===t);if(c!==-1){const s=r[c];s.totalTimeSpent=(s.totalTimeSpent||0)+e}else r.unshift({id:Date.now().toString(),url:i,title:"Unknown Title",timestamp:new Date().toISOString(),favicon:null,totalTimeSpent:e});const l=r.slice(0,1e3);await o.storage.local.set({websites:l})}o.tabs.onActivated.addListener(async i=>{const e=await o.windows.get(i.windowId);if(e.focused){if(n&&n.url&&n.windowId===e.id){const a=Date.now()-n.startTime;await m(n.url,a)}const t=await o.tabs.get(i.tabId);t.url&&!t.url.startsWith("chrome://")?n={tabId:i.tabId,url:t.url,startTime:Date.now(),windowId:i.windowId}:n=null}else if(n&&n.windowId===e.id){const t=Date.now()-n.startTime;await m(n.url,t),n=null}});o.tabs.onRemoved.addListener(async(i,e)=>{if(n&&n.tabId===i){const t=Date.now()-n.startTime;await m(n.url,t),n=null}});o.windows.onFocusChanged.addListener(async i=>{if(i===o.windows.WINDOW_ID_NONE){if(n){const e=Date.now()-n.startTime;await m(n.url,e),n=null}}else{const e=await o.tabs.query({active:!0,windowId:i});e.length>0&&e[0].url&&!e[0].url.startsWith("chrome://")?n={tabId:e[0].id,url:e[0].url,startTime:Date.now(),windowId:i}:n=null}});o.tabs.onUpdated.addListener((i,e,t)=>{if(e.status==="complete"&&t.url&&!t.url.startsWith("chrome://")){const a=t.url,r=w(a);o.storage.local.get(["websites"],c=>{const l=c.websites||[],s=l.findIndex(u=>w(u.url)===r);if(s!==-1){const u=l[s],b={id:u.id,url:a,title:t.title||"Unknown Title",timestamp:new Date().toISOString(),favicon:t.favIconUrl||null,totalTimeSpent:u.totalTimeSpent||0};l.splice(s,1),l.unshift(b)}else{const u={id:Date.now().toString(),url:a,title:t.title||"Unknown Title",timestamp:new Date().toISOString(),favicon:t.favIconUrl||null,totalTimeSpent:0};l.unshift(u)}const d=l.slice(0,1e3);o.storage.local.set({websites:d})})}});o.runtime.onMessage.addListener((i,e,t)=>{var a,r;if(i.type==="CLIPBOARD_CAPTURED"){const c={id:Date.now().toString(),content:i.content,timestamp:new Date().toISOString(),sourceUrl:((a=e.tab)==null?void 0:a.url)||null,sourceTitle:((r=e.tab)==null?void 0:r.title)||null};o.storage.local.get(["clipboard"],l=>{const s=l.clipboard||[];if(s.length>0&&s[0].content===c.content){t({success:!1,message:"Duplicate content ignored"});return}s.unshift(c);const d=s.slice(0,1e3);o.storage.local.set({clipboard:d})}),t({success:!0})}});
